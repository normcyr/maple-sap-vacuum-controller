# Maple Sap Vacuum Controller

## Purpose of the controller

## How to install the software

1. Modify the configuration file to match your system

A default configuration file is provided but at least need to be renamed in order to be used.

```bash
cp config.py.example config.py
```

Modify the value of the variable in `config.py` to match your requirements.

2. Copy the files to the ESP8266 controller

The required files should be copied to the controller file system:

```bash
cp BME280.py  \
   boot.py    \
   config.py  \
   i2c_lcd.py \
   lcd_api.py \
   main.py    \
   /pyboard/
```

## Testing with InfluxDB

It is possible to optionaly write the environmental data measured by the sensors to an InfluxDB server. Once properly parametrized, the Maple Sap Vacuum Controller should be able to write the data through the Wifi network to your InfluxDB server assuming you have one running on your local network. This goes beyond the scope of this guide and more information can be found the [website of InfluxDB](https://docs.influxdata.com/influxdb/v2.6/get-started/).

This can be minimally done using the [Compose plugin](https://docs.docker.com/compose/install/#scenario-two-install-the-compose-plugin) of Docker, run a local InfluxDB server and test it with random data generated by a specific module.

1. Start the InfluxDB server

```bash
docker-compose pull
docker-compose up -d
```

2. Generate an API token to write data

Go to `http://localhost:8086` and use the credentials from `influxdb.env` to log in. In `Load Data > API tokens`, click on `Generate an API token` and select the `Custom API token` to create a new one with Read and Write permissions on the `vacuum_pump` bucket. Copy the generated token to your `config.py` file and replace the value assigned to the `INFLUXDB_TOKEN` variable with the newly generated token.

The microcontroller will now be able to send POST requests to the InfluxDB server with the environmental data measured, using the line protocol and the API /write endpoint, [as defined by InfluxDB](https://docs.influxdata.com/influxdb/v2.6/write-data/developer-tools/api/).

3. Test if your setup can connect and write to your InfluxDB instance

Once you have a configured and properly running InfluxDB instance, you can test it with the `test_infludb.py` module.

```bash
python test_influxdb.py
```

It will generate random environmental data and print the data that is posted to your InfluxDB instance. The output should look like this:

```bash
cabane_a_sucre,sensor_id=env_inside_box temperature=1,humidity=91,pressure=1008,pump_started=True 1672707057
204
```

A successful POST request will output a 204 HTTP code. You can also check if the data was properly written by going to the `Data Explorer` section of the InfluxDB web service.

Note that you will need the Python `requests` module installed. You can do so by running the command `pip install -u requests`.
